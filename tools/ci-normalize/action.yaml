---
name: Upload normalized test results
description: Captures metadata, normalizes the test results and uploads to s3.

inputs:
  junit-files:
    required: true
    description: "junit files for normalization"

runs:
  using: composite
  steps:
    - name: Workaround go cache issue
      # https://github.com/actions/setup-go/issues/467#issuecomment-2551300160
      shell: bash
      run: |
        # Work around setup-go caching issue
        mkdir -p ${{ github.workspace }}/.tmp/actions/cache/amplify-preview
        go_sum_path=${{ github.workspace }}/.tmp/actions/cache/amplify-preview/go.sum
        cp ${{ github.action_path }}/go.sum ${{ github.workspace }}/.tmp/actions/cache/amplify-preview/
        echo "go_sum_path=${go_sum_path}" >> $GITHUB_OUTPUT
      id: cache_workaround

    - uses: actions/setup-go@v6
      with:
        go-version-file: ${{ github.action_path }}/go.mod
        cache-dependency-path: ${{ steps.cache_workaround.outputs.go_sum_path }}

    - name: Normalize and push
      id: normalize_and_push
      # Always tries to run regardless of job success.
      if: always()
      continue-on-error: true
      shell: bash
      working-directory: ${{ github.action_path }}
      run: |
        meta_file=$(mktemp)
        go run ./cmd meta --out $meta_file --out s3://
        # TODO: implement me
